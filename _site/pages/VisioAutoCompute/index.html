
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7 ie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8 ie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9 ie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Auto-computed values in Visio diagrams with VBA</title>
	<meta name="author" content="JH">
	<link href='http://jheyman.github.io/blog/assets/themes/mytheme/css/style.css' rel="stylesheet" media="all">
	<link href="http://feeds.feedburner.com/" rel="alternate" title="Auto-computed values in Visio diagrams with VBA" type="application/atom+xml">
	<script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.0.6/modernizr.min.js"></script>
</head>
<body>

<div id="page" class="hentry">
	<header class="the-header">
		<div class="unit-head">
			<div class="unit-inner unit-head-inner">
				<a href="http://jheyman.github.io/blog/index.html"><img src="http://jheyman.github.io/blog/assets/images/common/hotglue_and_homemade_bits.png" height="100%" class="center" /></a>
			</div><!-- unit-inner -->
		</div><!-- unit-head -->
	</header>
	<div class="body" role="main">
		<div class="unit-body">
			<div class="unit-inner unit-body-inner">
				<div class="entry-content">
					
<article class="unit-article layout-page">
	<div class="unit-inner unit-article-inner">
		<div class="content">
			<header>
				<div class="unit-head">
					<div class="unit-inner unit-head-inner">
						<h1 class="h2 entry-title">Auto-computed values in Visio diagrams with VBA</h1>
					</div><!-- unit-inner -->
				</div><!-- unit-head -->
			</header>

			<div class="bd">
				<div class="entry-content">
					
<p>I’m using Microsoft Visio quite often at work, and came to realize that it can do so much more than drawing nice diagrams. I was not aware of the very large developer community around Visio either.<br /></p>

<p>Anyway, I had a need for:</p>

<ul>
  <li><strong>associating data to shapes</strong> in my diagrams</li>
  <li>performing <strong>automatic data computation</strong> within Visio, without having to export/import to/from an external tool</li>
  <li><strong>displaying resulting data</strong> directly on the diagram<br /></li>
</ul>

<p>My specific intent was to apply this to electronics/mechanical block diagrams to provide instant visual feedback about cost, power consumption, volume, and mass, as a function of what components were added/removed from the diagram, and how they where interconnected.<br /></p>

<ul id="markdown-toc">
  <li><a href="#application" id="markdown-toc-application">Application</a>    <ul>
      <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
      <li><a href="#additional-features" id="markdown-toc-additional-features">Additional features</a></li>
    </ul>
  </li>
  <li><a href="#underlying-visio-mechanisms" id="markdown-toc-underlying-visio-mechanisms">Underlying Visio mechanisms</a>    <ul>
      <li><a href="#associating-data-to-shapes" id="markdown-toc-associating-data-to-shapes">Associating data to shapes</a></li>
      <li><a href="#computing-shape-data" id="markdown-toc-computing-shape-data">Computing shape data</a></li>
      <li><a href="#navigating-shape-connections" id="markdown-toc-navigating-shape-connections">Navigating shape connections</a></li>
      <li><a href="#displaying-results" id="markdown-toc-displaying-results">Displaying results</a></li>
      <li><a href="#visio-projet-file-and-vba-source-code" id="markdown-toc-visio-projet-file-and-vba-source-code">Visio projet file and VBA source code</a></li>
    </ul>
  </li>
  <li><a href="#vba-implementation-notes" id="markdown-toc-vba-implementation-notes">VBA implementation notes</a>    <ul>
      <li><a href="#visio-object-model--base-concepts" id="markdown-toc-visio-object-model--base-concepts">Visio object model &amp; base concepts</a></li>
      <li><a href="#shape-types" id="markdown-toc-shape-types">Shape types</a></li>
      <li><a href="#reading--writing-shape-data" id="markdown-toc-reading--writing-shape-data">Reading &amp; writing shape data</a></li>
      <li><a href="#basic-event-notification" id="markdown-toc-basic-event-notification">Basic Event notification</a></li>
      <li><a href="#custom-event-notification" id="markdown-toc-custom-event-notification">Custom Event notification</a></li>
      <li><a href="#custom-shape-data" id="markdown-toc-custom-shape-data">Custom shape data</a></li>
      <li><a href="#custom-dynamic-connector-text" id="markdown-toc-custom-dynamic-connector-text">Custom dynamic connector text</a></li>
      <li><a href="#automated-coloring--counting" id="markdown-toc-automated-coloring--counting">Automated coloring &amp; counting</a>        <ul>
          <li><a href="#interface-coloring--counting-implementation" id="markdown-toc-interface-coloring--counting-implementation">Interface coloring &amp; counting implementation</a></li>
          <li><a href="#connector-coloring-implementation" id="markdown-toc-connector-coloring-implementation">Connector coloring implementation</a></li>
        </ul>
      </li>
      <li><a href="#navigating-connectors" id="markdown-toc-navigating-connectors">Navigating connectors</a></li>
      <li><a href="#undo-management" id="markdown-toc-undo-management">Undo management</a></li>
      <li><a href="#shape-protection" id="markdown-toc-shape-protection">Shape protection</a></li>
    </ul>
  </li>
  <li><a href="#general-visio-tips" id="markdown-toc-general-visio-tips">General Visio Tips</a>    <ul>
      <li><a href="#glue-anywhere" id="markdown-toc-glue-anywhere">Glue anywhere</a></li>
      <li><a href="#customize-the-visio-ribbon" id="markdown-toc-customize-the-visio-ribbon">Customize the Visio Ribbon</a></li>
    </ul>
  </li>
  <li><a href="#useful-resources" id="markdown-toc-useful-resources">Useful resources</a></li>
  <li><a href="#lessons-learned" id="markdown-toc-lessons-learned">Lessons learned</a></li>
</ul>

<hr />

<h3 id="application">Application</h3>

<h4 id="overview">Overview</h4>

<p>The resulting sandbox I experimented with, as well as VBA implementation notes (in excruciating details, mostly as a memo to myself) are provided below.<br /></p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/overview.png" alt="Overview" /></p>

<ul>
  <li><strong>Components</strong> each have their own cost/mass/power consumption/volume, assigned through shape data window.
<img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/component_shape_data.png" alt="shape data" /></li>
  <li><strong>Connectors</strong> link components with each other, and they each have one associated data: the number of physical signals carried by this link (think “number of individual wires”) 
<img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/connector_shape_data.png" alt="custom field" /></li>
  <li><strong>Containers</strong> allow to group Components, e.g. to represent the electronics components being part of the same PCB.<br /></li>
  <li><strong>Interfaces</strong> are used to structure incoming/outgoing connectors to/from a container. They automatically count (and display) the number of connectors that are inside the container (think “PCB traces”) and the number of connectors that are external (think “external cables/wires”).<br /></li>
  <li><strong>Local (container) totals</strong> are boxes that automatically compute the sum of values of contained shapes, for the criteria that they track (i.e. cost,  mass, power, or volume).<br />
<strong>Note</strong>: I positioned these text boxes on the <strong>edge</strong> of the container, not inside (the container’s perimeter is highlighted when a shape is about to be dropped on its edge). This way, the boxes are still part of the container, but it also ensures that they stay attached to the container’s edge whenever it gets resized, which I think makes more sense for something showing data linked to the container’s content.</li>
</ul>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/interface_drop_on_edge.png" alt="interface_drop_on_edge " /></p>

<ul>
  <li><strong>Global totals</strong> are boxes that automatically compute the sum of values for all shapes on the diagram,  for the criteria that they track (i.e. cost,  mass, power, or volume).</li>
</ul>

<h4 id="additional-features">Additional features</h4>

<ul>
  <li>automatic coloring: adjustement of internal connectors and interfaces color to the color of their container</li>
  <li>automatic computation of total internal/external signals on each Interface</li>
  <li>the nb of signals carried by a connector is inserted in the connectors’ text (while hiding it during text edition by user)</li>
</ul>

<hr />

<h3 id="underlying-visio-mechanisms">Underlying Visio mechanisms</h3>

<h4 id="associating-data-to-shapes">Associating data to shapes</h4>

<p>The Professional version of Visio has a specific feature to simplify this usecase (“data graphics”), but I usually only have access to the Standard version, so I had to find a workaround. Fortunately, all versions of Visio provide a basic feature for associating user data to shapes. To access a specific shape’s date, right-click on it =&gt; “Data” =&gt; <strong>“Shape Data”</strong>. Data of various types (integer, float, string, …) can be created from there. <br /></p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/component_shape_data.png" alt="shape data" /></p>

<p>In this example I manually added some cost/mass/power/volume shape data to a basic “component” shape.<br /></p>

<p>Better yet, to apply a consistent set of data to multiple shapes, it is possible to create a shape data set: right-click on Shape Data window =&gt; <strong>“Shape Data Sets”</strong>.<br /></p>

<p>In fact, these user-created data are only a small subset of the data associated to a shape: each shape also has by default a lot of built-in data that Visio uses to store information about the shape (geometry, content, format, …). This whole set of  data is available in the <strong>Shapesheet</strong>, accessible from the <code>Developer</code> tab of the UI (you may need to customize the Ribbon to make this Developer tab visible):</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/shapesheet.png" alt="shape sheet" /></p>

<p>My specific need was creating summary data for a set of shapes, based on the combination of individual shape data (in this case, just a sum of the individual cost/mass/volume values). The most convenient way I found was to use visio <code>Containers</code> to group shapes. Containers are shapes too, so they can have associated data.</p>

<h4 id="computing-shape-data">Computing shape data</h4>

<p>The remaining part was then to find a way to compute container data, from the individual data of the shapes it contains. There are several ways to manipulate data programmatically in Visio:<br /></p>

<ul>
  <li>writing formulas directly within the <strong>ShapeSheet</strong></li>
  <li><strong>VBA</strong> macros/procedures (Visual Basic for Applications)</li>
  <li><strong>C#</strong> code</li>
  <li>and more…<br /></li>
</ul>

<p>ShapeSheet formulas can be just fine for simple computations, but I chose VBA to have a bit more flexibility / readability.</p>

<h4 id="navigating-shape-connections">Navigating shape connections</h4>

<p>Sooner or later, it will be interesting to compute data for a shape based on what other/shapes are linked to it via Connectors. Visio has two important concepts:</p>

<ul>
  <li>A shape is <strong>connected</strong> to another shape when at least one connector exists between them</li>
  <li>A connector endpoint can be <strong>glued</strong> to a shape<br /></li>
</ul>

<p>For example:</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/shapes_and_connections.png" alt="shapes_and_connections" /></p>

<ul>
  <li>Shape A is <strong>connected</strong> to shape B</li>
  <li>Connector1 and 2 are <strong>glued</strong> to shapes A and B</li>
  <li>Connnector3 is <strong>glued</strong> to shape B</li>
</ul>

<h4 id="displaying-results">Displaying results</h4>

<p>Since the Standard version of visio does not have the <code>Data Graphics</code> feature, I chose a simple workaround: adding specific shapes (boxes) in the container, which <strong>text</strong> will be updated to reflect the value of the container’s data.
The trick is to associate one shape data to these boxes, and then to insert a <strong>custom text field</strong> as the text for the box: from the <code>Insert</code> tab, select ‘Insert’ / ‘Field’ / ‘custom field’ and type <code>=Prop.xxxx</code> with ‘xxxx’ being the name of the shape property (data) to be displayed.</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/customfield.png" alt="custom field" /></p>

<p>As a result, the box’s text will now reflect its shape data value whenever if changes. <br /></p>

<p>Another possible alternative would be to use <strong>custom callouts</strong>, also available in visio standard, and allowing to display shape data values.</p>

<h4 id="visio-projet-file-and-vba-source-code">Visio projet file and VBA source code</h4>

<p>The Visio example file and VBA classes source code are available <a href="https://github.com/jheyman/visioautocriteria">here</a> for reference.</p>

<hr />

<h3 id="vba-implementation-notes">VBA implementation notes</h3>

<h4 id="visio-object-model--base-concepts">Visio object model &amp; base concepts</h4>

<p>The relevant entities that we manipulate for this usecase are shown below (representing a very limited subset of the full Visio object model):</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/visio_object_model_subset.png" alt="visio object model" /></p>

<p>They are leveraged as follows:</p>

<ul>
  <li><strong>Application</strong> top-level object is used to access the collection of opened Windows, as well as get the global context for user action (to manage undo actions, more on this later..)</li>
  <li><strong>ThisDocument</strong> object is implicitly used throughout the VBA code</li>
  <li><strong>ActiveWindow</strong>/<strong>ActivePage</strong>/<strong>ActiveDocument</strong> objects are used to keep track of the window/page/document that the code manipulates</li>
  <li><strong>Windows</strong> collection is used implement an event hook to detect when the active page changes</li>
  <li><strong>EventList</strong> is used to register customized event notifications</li>
  <li><strong>Documents</strong> collection is not accessed directly, but <strong>Document</strong> object is used to add an event hook executed when our document is opened to perform some initializations</li>
  <li><strong>Pages</strong> collection is not accessed directly, but the (current) <strong>Page</strong> object is used to declare event hooks on many events related to modifications of the shapes contained on the page</li>
  <li><strong>Shapes</strong> collection is used to lookup a particular shape based on its ID, and then <strong>Shape</strong> objects are used throughout the code to manipulate shape parameters and data<br /></li>
</ul>

<p>Each Shape has, among other things:</p>

<ul>
  <li><strong>Cells</strong>, arranged in <strong>Rows</strong> themselves arranged in <strong>Sections</strong>, they are the basic entities carrying shape information</li>
  <li><strong>Connects</strong> collection that is used to examine incoming/outgoing links to/from a specific shape</li>
  <li>a <strong>Name</strong> (modifiable by the developer)</li>
  <li>a unique <strong>ID</strong> set by the internal Visio engine<br /></li>
</ul>

<p><strong>Note</strong>: for historical reasons, shape are referred to as “Sheets”, therefore shape names are created with the name <code>Sheet.xx</code>, with <code>xx</code> being their ID.<br /></p>

<p>So, in our example:</p>

<ul>
  <li><strong>Components</strong>, <strong>Containers</strong>, <strong>Interfaces</strong>, <strong>Connectors</strong>, and <strong>Criteria boxes</strong> are Shapes.</li>
  <li>They all live inside a <strong>Page</strong>, contained within a <strong>Document</strong>, and their <strong>Cells</strong> are modified in the context of an Application (the Visio program)</li>
  <li>The internal Visio engine, that manages all user actions, also executes our VBA code that acts upon these Cells</li>
  <li>our VBA code lives in two classes: the <strong>ThisDocument</strong> class, and the <strong>clsEventSink</strong> class (detailed later)</li>
</ul>

<h4 id="shape-types">Shape types</h4>

<p>When manipulating shapes programmatically, it is important to note that their are various shape types out there. A specific shape’s type is available in its <code>Type</code> parameter. In my case, I applied filtering here and there in the code to only care for:</p>

<ul>
  <li>regular Shapes (<code>visTypeShape</code>)</li>
  <li>groups of Shapes (<code>visTypeGroup</code>)</li>
  <li>Pages/Masters (<code>visTypePage</code>)</li>
</ul>

<p>I filter out everything else (like <strong>Guides</strong>, Visio’s vertical/horizontal visual hints, or Bitmap images, or one othe many other types of shapes) from event callbacks to prevent unwanted effects. The complete list of Visio Shape types is available <a href="https://msdn.microsoft.com/en-us/library/office/ff767768.aspx">here</a>.
<br />
Also, among regular Shapes, some are Containers, they are the ones with a non-null <code>ContainerProperties</code> object</p>

<h4 id="reading--writing-shape-data">Reading &amp; writing shape data</h4>

<p>Each <strong>Cell</strong> in a Shape has two important properties in our usage:</p>

<ul>
  <li><strong>Formula</strong> contains the…formula used to compute the cell value.</li>
  <li><strong>Result</strong> (and its variants like ResultStr) stores…the result of the latest formula computation evaluation.</li>
</ul>

<p>Reading and writing from/to Cells therefore boils down to accessing these two properties:</p>

<pre><code>myShape.Cells("Prop.myPropName").Result
myShape.Cells("Prop.myPropName").Formula = "xyz"
</code></pre>

<p><strong>Note</strong>: the <code>Cells</code> accessor takes a string parameter (the name of the target cell), while the <code>CellSRC</code> accessor takes the section/row number of the target cell as input.<br /></p>

<p><strong>Note</strong>: for several properties in the Visio object model, two accessors are accessible: <code>&lt;PropertyName&gt;</code> and <code>&lt;PropertyName&gt;U</code>. The version with the appended “U” allows to access the property via the Universal name, that is localization-independent, while the version without the U uses the localized name.<br /></p>

<p><strong>Note</strong>: a Cell’s result value is stored as a string in parameter ResultStr, and its last parameter allows to specify how to cast this string into a specific unit/type of value. Available Visio <strong>Units</strong> are defined <a href="https://msdn.microsoft.com/en-us/library/office/ff769148.aspx">here</a>.<br /></p>

<p><strong>Note</strong>: Since Formula property is a string, sometime the syntax can get weird to actually use a string inside a formula. To avoid having to use confusing triple quotes, and easier way is to use <code>CHR(34)</code>, as in e.g.:</p>

<pre><code>    Shape.CellsU("Prop." &amp; connectorUserText).FormulaU = Chr(34) &amp; Shape.Text &amp; Chr(34)
</code></pre>

<p><strong>Note</strong>: the Formula property can be used to cross-reference the property of <em>another</em> Shape as the source value in the computation, using the <code>&lt;ShapeName&gt;!&lt;PropertyName&gt;</code> syntax, as in e.g.:</p>

<pre><code>    shp.CellsSRC( ... ).FormulaU = containerShp.Name &amp; "!FillForegnd"
</code></pre>

<h4 id="basic-event-notification">Basic Event notification</h4>

<p>The internal Visio engine emits many different <strong>Events</strong> when manipulating a diagram. It is then possible from VBA code to register to some of these events, by declaring a hook/callback to be executed when the event occurs. Three steps are required:<br />
1) Use the <code>WithEvents</code> keyword to declare an object which events we want to be notified of. In this case, we want to track events occuring to the <strong>Windows</strong> object, and to the <strong>Page</strong> object</p>

<pre><code>Dim WithEvents win As Visio.Windows
Public WithEvents pg As Visio.Page
</code></pre>

<p>2) Initialize these variables, using the applicable references for our execution context:</p>

<pre><code>Set win = Visio.Application.Windows
Set pg = ActivePage
</code></pre>

<p>3) Declare event hooks/callbacks for these objects, using the following syntax</p>

<pre><code>&lt;var&gt;_&lt;predefined name of the event&gt; 
</code></pre>

<p>In practice I used the following event hooks:</p>

<ul>
  <li><strong>Document_DocumentOpened</strong> is used to trig one-time init actions upon opening our visio document. <strong>Note</strong>: there is no need for a “doc_” prefix and the associated <code>WithEvents</code> declaration for this specific case, since inside the <code>ThisDocument</code> VBA class, this is implicit.</li>
  <li><strong>pg_CellChanged</strong> is used to detect (user-initiated) modifications of a shape data and react accordingly.</li>
  <li><strong>pg_ShapeExitedTextEdit</strong> is used to detect when the user has just finished editing the name of a shape, to adjust this name programmatically (more on this later)</li>
  <li><strong>win_WindowTurnedToPage</strong> is used to keep track of which Page is currently being worked on and refresh our <strong>pg</strong> variable to capture the right events.</li>
  <li><strong>pg_ShapeAdded</strong> is used to recompute totals when a shape is added on the page.</li>
  <li><strong>pg_ConnectionsAdded</strong> is used to update Interface data when links are being made</li>
  <li><strong>pg_ConnectionsDeleted</strong> is used to update Interface data when links are being removed</li>
  <li><strong>pg_ContainerRelationshipAdded</strong> is used to detect when a shape is created in / moved in a container</li>
  <li><strong>pg_ContainerRelationshipDeleted</strong> is used to detect when a shape is removed / moved out of a container<br /></li>
</ul>

<p><strong>Note</strong>: Pro versions of Visio include a very useful <em>Event Monitor</em> tool, tracing all events occurring in realtime, so you can figure out which event to capture for a specific action. Since this tool is not available in the Standard version, I downloaded an evaluation version of Visio Professional, ran a few tests, identified the relevant events, then went back to developing in my Standard version. Browsing the reference documentation works too, but I’m lazy.<br /></p>

<p><strong>Note</strong>: the <code>BeforeSelectionDelete</code> event might have been useful to me, except it gets called <em>before</em> the selected shape gets deleted, and is therefore not a good place to trig recomputation of data: since the shape is not deleted yet, everything is still unchanged data-wise…therefore, the need for custom events.</p>

<h4 id="custom-event-notification">Custom Event notification</h4>

<p>For performance reasons, not all possible events are being managed by default by the Visio engine. For my example, I needed to have access to two of these special events: <strong>onShapeDeleted</strong> and <strong>onBeforeShapeTextEdit</strong>. It is a bit more complex than just the <code>WithEvents</code> declaration approach used for regular/default events. The required steps are:<br /></p>

<p>1) Create a custom Event sink class, implementing the <code>IVisEventProc_VisEventProc</code>. Hence the presence of the <strong>clsEventSink</strong> VBA class in my project.</p>

<pre><code>Implements Visio.IVisEventProc

Private Function IVisEventProc_VisEventProc( _
    ByVal nEventCode As Integer, _
    ByVal pSourceObj As Object, _
    ByVal nEventID As Long, _
    ByVal nEventSeqNum As Long, _
    ByVal pSubjectObj As Object, _
    ByVal vMoreInfo As Variant) As Variant
  
    ' Custom event handler
    Select Case nEventCode
        Case visEvtCodeShapeDelete
            Debug.Print "Custom EVENT visEvtCodeShapeDelete received"
            ThisDocument.onShapeDeleted
        Case visEvtCodeShapeBeforeTextEdit
            Debug.Print "Custom EVENT visEvtCodeShapeBeforeTextEdit received"
            ThisDocument.onBeforeShapeTextEdit pSubjectObj
        Case Else
            Debug.Print "EVENT " &amp; nEventCode &amp; " received"
    End Select

End Function
</code></pre>

<p>2) Instanciate this event sink and register it to the global <strong>EventList</strong> using the <strong>AddAdvise</strong> function, passing the required specific event code as a parameter:</p>

<pre><code>' declare our custom event handler (implemented in our clsEventSink class)
Dim eventHandler As clsEventSink
Set eventHandler = New clsEventSink

' Attach our custom event handler to the appropriate event codes:
ThisDocument.EventList.AddAdvise visEvtCodeShapeDelete, eventHandler, "", ""
ThisDocument.EventList.AddAdvise visEvtCodeShapeBeforeTextEdit, eventHandler, "", ""
</code></pre>

<p>At the time of writing, the full list of these event codes was available <a href="https://msdn.microsoft.com/en-us/library/office/ff768620.aspx">here</a> in the Visio developer documentation.</p>

<h4 id="custom-shape-data">Custom shape data</h4>

<ul>
  <li><strong>Components</strong> have custom volume/cost/mass/power data, stored in Cells named <code>Prop.volume</code>, <code>Prop.cost</code>, <code>Prop.mass</code>, and <code>Prop.power</code></li>
  <li><strong>Containers</strong> have the same properties, since they themselves can have a mass/cost/power/volume (think: a naked PCB)</li>
  <li><strong>Connectors</strong> have custom associated data to store the number of signals being carried <code>Prop.nbSignals</code>, as well as other data to keep track of the user text for the connector, since it gets dynamically reconstructed any time the nb of signal changes</li>
  <li><strong>Interfaces</strong> have custom data to track the number of internal and external signals passing through to them, stored in <code>Prop.interfaceInternalLinks</code> and <code>Prop.interfaceExternalLinks</code></li>
  <li><strong>Criteria boxes</strong> have custom data to store their associated criteria value: <code>Prop.criteriavalue</code></li>
</ul>

<h4 id="custom-dynamic-connector-text">Custom dynamic connector text</h4>

<p>The displayed text on each connector is dynamically computed, based on the name that the user set for this link, completed by the value of the connector data representing the number of signals being carried. To achieve this:</p>

<ul>
  <li>the connector name set by the user is stored in one of the shape data parameter <code>Prop.userName</code></li>
  <li>
    <p>when receiving the <code>BeforeShapeTextEdit</code> event, the code temporarily restores the original connector name so that the user can edit it without bothering about the computed part
<img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/link_duringrename.png" alt="link during rename" /></p>
  </li>
  <li>
    <p>when receiving the <code>ShapeExitedTextEdit</code> event, the code recomputes the full text based on the newly set user text, and adding the current signals data value within parenthesis
<img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/connector_shape_data.png" alt="link after rename" /></p>
  </li>
  <li>we also capture the <code>CellChanged</code> event, and recompute the text in case the number of carried signals was changed by the user (from the shape data window)</li>
</ul>

<h4 id="automated-coloring--counting">Automated coloring &amp; counting</h4>

<p>The color of Connectors and Interfaces in a given container are dynamically adjusted to the color of the container:</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/container_color1.png" alt="container_color1 " /></p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/container_color2.png" alt="container_color2" /></p>

<h5 id="interface-coloring--counting-implementation">Interface coloring &amp; counting implementation</h5>

<p>If the Interface is inside a container:</p>

<ul>
  <li>its color is adjusted to the color of the container by assigning a reference to the <code>FillForegnd</code> parameter of the parent container inside the formula for the Interface’s <code>FillForegnd</code>. <strong>Note</strong>: an additional element in the formula consists in using the TINT function to increase the luminosity of the source color.</li>
</ul>

<pre><code>CellsU("FillForegnd").FormulaU = "TINT(" &amp; containerShp.Name &amp; "!FillForegnd" &amp; ", 50)"</code></pre>

<ul>
  <li>its internal/external signal counts are set such that <strong>internal</strong> signals correspond to the total number of signals coming from connectors inside the container, while <strong>external</strong> signals correspond to the total number of signals coming from connectors outside the container:</li>
</ul>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/interface_inside.png" alt="interface_inside " /></p>

<p>If the Interface is outside any container:</p>

<ul>
  <li>its color is adjusted to a default value:</li>
</ul>

<pre><code>CellsU("FillForegnd").FormulaU = ExternalInterfaceFillColor</code></pre>

<ul>
  <li>and all its signal are then external by definition:</li>
</ul>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/interface_outside.png" alt="interface_outside " /></p>

<h5 id="connector-coloring-implementation">Connector coloring implementation</h5>

<p>If the Connector is inside a container:</p>

<ul>
  <li>its color is adjusted to the color of the container, by assigning a reference to the <code>FillForegnd</code> parameter of the parent container inside the formula for the Connector’s <code>LineColor</code></li>
</ul>

<pre><code>CellsU("LineColor").FormulaU = containerShp.Name &amp; "!FillForegnd"</code></pre>

<ul>
  <li>its text color is also adjusted, by assigning a reference to the <code>FillForegnd</code> parameter of the parent container inside the formula for the Connector’s text color:</li>
</ul>

<pre><code>CellsSRC(visSectionCharacter, 0, visCharacterColor).FormulaU = containerShp.Name &amp; "!FillForegnd"</code></pre>

<p>If the connector is outside any container,  its color is adjusted to a default value in a similar way:</p>

<pre><code>CellsU("LineColor").FormulaU = ExternalConnectorLineColor
CellsSRC(visSectionCharacter, 0, visCharacterColor).FormulaU = ExternalConnectorLineColor</code></pre>

<h4 id="navigating-connectors">Navigating connectors</h4>

<p>As mentioned earlier, shapes can be <strong>connected</strong> to other shapes via connectors, and connectors can be <strong>glued</strong> to shapes’ connection points. From a code standpoint,<br /></p>

<ul>
  <li>An array of IDs of shapes glued to a given shape is accessible through the <code>GluedShapes</code> function. Since I am mostly interested in counting connectors glued to an Interface shape, I used the <code>visGluedShapesIncoming1D</code> and <code>visGluedShapesOutgoing1D</code> filter codes to only look for these, and then merged both ID lists.</li>
</ul>

<pre><code>arySourceIDs = shp.GluedShapes(visGluedShapesIncoming1D, "")
aryTargetIDs = shp.GluedShapes(visGluedShapesOutgoing1D, "")</code></pre>

<ul>
  <li>Similarly, the <code>ConnectedShapes</code> function returns an array of ID a shapes connected to the target shape.<br /></li>
</ul>

<p>For this example:</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/shapes_and_connections.png" alt="shapes_and_connections" /></p>

<p>The result is as follows:</p>

<pre><code>Shapes glued to shape Sheet.2:
              Connector 2(shapeId=7, Name=link.7)
              Connector 1(shapeId=8, Name=link.8)
Shapes connected to shape Sheet.2:
              Shape B(shapeId=3, Name=Sheet.3)
Shapes glued to shape Sheet.3:
              Connector 2(shapeId=7, Name=link.7)
              Connector 1(shapeId=8, Name=link.8)
              Connector 3(shapeId=9, Name=link.9)
Shapes connected to shape Sheet.3:
              Shape A(shapeId=2, Name=Sheet.2)
</code></pre>

<p>In my case, I was also interested in examining the other end of each connector glued to a shape, to figure out if something is connected there. Each Connector has a list of <code>Connects</code>, that represent the link between a connector endpoint and an anchor shape. A  <code>Connect</code> has two parameters, a <code>FromSheet</code> and a <code>ToSheet</code>, corresponding to the two shapes being attached.</p>

<h4 id="undo-management">Undo management</h4>

<p>One tricky bug I encountered only happened while doing a very specific action, and then UNDO-ing it (e.g. hitting Ctrl-Z). I finally learned that it was actually much simpler (and good practice) to <strong>prevent all my custom VBA callbacks from executing during undo operations</strong>: indeed, what the callbacks do is process data and in the end update some of the shapes’ cells with new values. During Undo, the Visio internal engine reverts cells values to whatever they where before, making it completely unnecessary to recompute anything. The top-level Application object provides the <strong>IsUndoingOrRedoing</strong> boolean variable, which can be used to just return from the callback when the execution context is an UNDO operation.</p>

<p>Applicable documentation is available <a href="https://msdn.microsoft.com/en-us/library/office/bb435911.aspx">here</a>.</p>

<h4 id="shape-protection">Shape protection</h4>

<p>For some of the elements on the diagrams, it may be useful to lock user modifications for some aspects of the shape. For example, there is no good reason to let the user resize or change the text inside the criteria boxes. Locking is achieved through the “Protection” window for the shape, available in the <code>Developer</code> tab. Below is the example setting for criteria boxes:</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/protections.png" alt="Protections" /></p>

<h3 id="general-visio-tips">General Visio Tips</h3>

<h4 id="glue-anywhere">Glue anywhere</h4>

<p>All Visio Shapes have predefined connection points for connectors:</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/glue_to_connection_point.png" alt="glue_to_connection_point" /></p>

<p>However, quite often for complex diagrams more connection points are required for a visually pleasing result. There are two ways to address this need:<br /></p>

<ul>
  <li>
    <p>Creating additional connection points, by selecting the shape, selecting the connection point tool, and clicking somewhere on the shape’s perimeter. This approach gets tiresome pretty quickly though…
<br /></p>
  </li>
  <li>
    <p>A much simpler way is to enable the <code>Glue to Shape Geometry</code> option. For some reason, not only is this not enabled by default, but the associated button/icon to activate it is not available anywhere in the Ribbon either. To add it in the Ribbon, right-click on it, select <code>Customize the Ribbon</code>, then display select “All Commands” on the left, look for the <code>Glue to Shape Geometry</code> entry and insert it somewhere in a custom group.</p>
  </li>
</ul>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/ribbon_customization_menu.png" alt="ribbon_customization_menu" /></p>

<p>For convenience, I also included the other available glue option buttons in the same tab:</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/glue_tools.png" alt="glue_tools" /></p>

<p>When <code>Glue to Shape Geometry</code> is active, connectors can now be glued anywhere on the perimeter of a shape:</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/glue_to_geometry.png" alt="glue_to_geometry" /></p>

<p>Major productivity boost when dealing with tens of connections !<br /></p>

<p>The <code>Glue to Vertex</code> option is not as interesting, but still good to know:</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/glue_to_vertex.png" alt="glue_to_vertex" /></p>

<h4 id="customize-the-visio-ribbon">Customize the Visio Ribbon</h4>

<p>Over time I came to dislike having to navigate through the ribbon tabs, and since I typically use the same limited subset of commands 99% of the time, I customized the ribbon to have them all in a single tab, and only display this tab:</p>

<p><img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/customized_ribbon1.png" alt="customized_ribbon1" />
<img src="http://jheyman.github.io/blog/assets/images/VisioAutoCompute/customized_ribbon2.png" alt="customized_ribbon2" /></p>

<p>Also, the  <code>Import/Export</code> feature in the Ribbon customization menu is nice, to save your current customization layout, for instant customization of a fresh Visio install on another PC or something.</p>

<h3 id="useful-resources">Useful resources</h3>

<ul>
  <li>The <a href="https://msdn.microsoft.com/en-us/library/aa830792(v=office.10).aspx">Microsoft Visio Automation Reference</a> documentation on MDSN is surprisingly good.</li>
  <li>But without a doubt, the <a href="www.visguy.com/">Visio Guy</a> site/forum is the most useful place for all Visio developers.</li>
  <li>the Visio <strong>VBA object reference</strong> is available <a href="https://msdn.microsoft.com/en-us/library/office/ff765377.aspx">here</a></li>
</ul>

<h3 id="lessons-learned">Lessons learned</h3>

<ul>
  <li>This was my very first experience with VBA and I expected to be disappointed, but it turned out to be quite OK in fact. The only grudge I have is with the VBA user interface inside Visio, which has not been brought to today’s IDE standards.</li>
  <li>I only scratched the surface of the automation possibilities in Visio, it really opened my eyes to their extent.</li>
</ul>

				</div><!-- entry-content -->

				<br>
				<hr>
				<div class="misc-content">			
					


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jheymantechblog'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




				</div><!-- misc-content -->				
			</div><!-- bd -->

			<footer class="unit-foot">
				<div class="unit-inner unit-foot-inner">
					<p class="gotop">
						<a href="#page">Back to Top</a>
					</p>
				</div>
			</footer>

		</div><!-- content -->
	</div><!-- unit-inner -->
</article>


				</div>
			</div><!-- unit-inner -->
		</div><!-- unit-body -->
	</div><!-- body -->
	<footer class="the-footer">
		<div class="unit-foot">
			<div class="unit-inner unit-foot-inner">
				<div class="misc vcard">
					<h4>about</h4>
					<ul>
						<li class="contact"><address><span class="author fn n">JH</span> - <span class="fn email">bidsomail at gmail.com</span></address></li>
						<li>Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a>, theme based on the_minimum from <a href="http://jekyllbootstrap.com/">Jekyll-bootstrap</a></li>
					</ul>
				</div><!-- misc -->
			</div><!-- unit-foot-inner -->
		</div><!-- unit-foot -->
	</footer>
</div><!-- page -->
<script>
	(function(d, s) {
		var js, fjs = d.getElementsByTagName(s)[0], load = function(url, id) {
		if (d.getElementById(id)) {return;}
		js = d.createElement(s); js.src = url; js.id = id;
		fjs.parentNode.insertBefore(js, fjs);
		};
	load('//platform.twitter.com/widgets.js', 'tweetjs');
	// load('https://apis.google.com/js/plusone.js', 'gplus1js'); // Checkout http://j.mp/ApDgMr for usage html for this is <div class="g-plusone" data-size="medium"></div>
	// load('//connect.facebook.net/en_US/all.js#xfbml=1', 'fbjssdk'); // Checkout http://j.mp/wZw2xR for using open graph protorol html for this is <div class="fb-like" data-href="/pages/VisioAutoCompute/" data-send="false" data-layout="button_count" data-width="450" data-show-faces="false" data-font="verdana"></div>
	}(document, 'script'));
</script>
<script>
/*! A fix for the iOS orientationchange zoom bug.Script by @scottjehl, rebound by @wilto. MIT License.*/
(function(j){var i=j.document;if(!i.querySelectorAll){return}var l=i.querySelectorAll("meta[name=viewport]")[0],a=l&&l.getAttribute("content"),h=a+", maximum-scale=1.0",d=a+", maximum-scale=10.0",g=true,c=j.orientation,k=0;if(!l){return}function f(){l.setAttribute("content",d);g=true}function b(){l.setAttribute("content",h);g=false}function e(m){c=Math.abs(j.orientation);k=Math.abs(m.gamma);if(k>8&&c===0){if(g){b()}}else{if(!g){f()}}}j.addEventListener("orientationchange",f,false);j.addEventListener("deviceorientation",e,false)})(this);
</script>

  


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-43264312-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



</body>
</html>

